# Infra
Данный проект предназначен для работы с Harbor registry, Vault, а так же для создания переменных в группах проектов GitLab для работы с кластерами Kubernetes.
Поддерживаемый функционал:
1. **Harbor**: первоначальная настройка (LDAP, Garbage Collection,Vulnerability Scaner); cоздание проектов (назначение квоты, сканирование на уязвимости и уровень приватности); добавления в них доменных пользователей и групп, с назначением им ролей; создание переменных (harbor url и логин и пароль для сервисной учетной записи для доступа к проекту) в группах проектов GitLab для работы с Harbor.
2. **Vault**: первоначальная настройка авторизации (ldap, userpass, approle); создание secret engines; создание "директорий" с секретами; создание и управление политиками доступов на основе шаблонов, с привязка к ним доменных групп и пользователей; создание переменных в группах проектов GitLab для работы с Vault (role-id,secret-id).
3. **K8S SA vars**: создание переменных в группах проектов (название кластера, его url, токен и базовый namespace) для работы с кластерами K8S, неймспейсы в которых созданы с помощью проекта k8s-infra.

# Настройка
1. Необходимо задать следующие переменные:
    - AWS_ACCESS_KEY_ID (от вашего s3 бакета, для хранения tfstate)
    - AWS_SECRET_ACCESS_KEY (от вашего s3 бакета, для хранения tfstate)
    - CI_GITLAB_ADMIN_TOKEN (токен от GitLab с возможностью создание, удаления и редактирования переменных в проектах)
    - CI_HARBOR_PASSWORD (пароль от пользователя с правами админа в Harbor)
    - CI_HARBOR_URL (url вашего Harbor registry)
    - CI_HARBOR_USER (имя пользователя с правами админа в Harbor)
    - CI_VAULT_TOKEN (токер пользователя с административными правами на Vault)
    - CI_VAULT_URL (url вашего Vault)
    - VAULT_SVC_PASSWORD (пароль от доменной сервисной четной записи Vault для авторизации в ldap)
    - HARBOR_SVC_PASSWORD (пароль от доменной сервисной четной записи Harbor)
    - HARBOR_SVC_USER (имя сервисной доменной четной записи Harbor под которой он будет ходить в домен)
    - K8S_PROD_TOKEN (токен сервис аккаунта из-под которого будут доставаться токены из секретов для доступа к неймспейсам в кубере)
    - K8S_TEST_TOKEN (аналогично предыдущему, кластеров может быть сколько угодно, эти приведены для примера)
2. Настроить конфигурационные файлы:
    - harbor-config.tf
    - sa-config.tf
    - vault-config.tf
    - backend.tf
3. Скачать необходимые провайдеры terraform и положить их в директорию configs\providers в соответствующие папки, необходимые версии указаны в txt файлах, для того что бы провайдеры каждый раз не качались из интернета. Если в этом нет необходимости то можно удалить файл .terraform.lock.hcl, директорию config/providers и внести изменения в .gitlab-ci.yml.

# Harbor
Для создания нового проекта в Harbor'e нужно создать yaml файл в директории HARBOR_PROJECTS по аналогии с values.yaml в helm чартах.
-  **gitlab_url**: добавить ссылку на группу проекта в GitLab (именно ссылка на группу в которой находится проект, а не на сам проект), далее туда будут добавляться переменные для работы с Harbor. При оставление этого поля пустым, проект так же будет создан.
-  **storage_quota**: указывается квота на проект в Gb, если квота не будет указанна, то она будет выставлена равная 3Gb.
-  **vulnerability_scanning**: данная переменная отвечает, за включение автоматического сканирования образов при их пуше в репозиторий и может принимать значения true или false. (true - сканировать автоматически при пуше образа, false - пушить без сканирования)
-  **public**: отвечает, за уроверь доступа к проекту, публичный или частный и может примать значения true или false, публичный по умолчанию доступен для пула образа всем (true - публичный, false - приватный).
-  **users**: в переменной задаются пользователи для проекта, например test-user2/maintainer, где test-user2 имя пользователя, а maintainer его роль. В качестве роли доступы: projectadmin, developer, guest, maintainer и limitedguest. По умолчанию в проет добавляется технический пользователь harbor-api с ролью developer, он необходим для выгрузки разнообразных отчетов по проектам, так как на данный момент в Harbor нет реализации readonly пользователя для всех проектов.
-  **groups**: задаются группы пользователей ldap для проекта, например test-group2/maintainer, где test-group2 имя группы пользователей, а maintainer его роль. Роли полностью аналогичный таковым у пользователей.

_Пример YAML файла, для создания проекта:_
```
####__HARBOR__###
#GitLab URL
gitlab_url: http://gitlab.local/testns2
#Project
storage_quota: 5
vulnerability_scanning: false
public: true
users: 
  - test-user2/maintainer
  - test-user3/maintainer
groups: 
  - test-group3/maintainer
```

# Service account
Для добавления переменных в группы проектов в Gitlab при работе с кластерами кубера, неймспейсы которых созданы через проект k8s-infa нужно создать yaml файл в директории SERVICE_ACCOUNTS. В нем задаются следующие параметры:
-  **gitlab_url**: добавить ссылку на группу проекта в GitLab (именно ссылка на группу в которой находится проект, а не на сам проект), далее туда будут добавляться переменные для работы с Harbor. При оставление этого поля пустым, проект так же будет создан и переменные для работы с ним будут выведены в лог пайплайна.
-  **k8s_clusters**, через этот параметр задаётся кластер или список кластеров, для которых будут добавлены переменные, такие как базовый неймспейс, url кластеров, из название и токены.

_Пример YAML файла, для создания переменных в группе проекта:_
```
####__K8S_SERVICE_ACCOUNT__###
#GitLab URL
gitlab_url: http://gitlab.local/testns
#K8S cluster
k8s_clusters: 
  - k8s-prod
  - k8s-test
```

# Vault
Для создания нового проекта в Harbor'e нужно создать yaml файл в директории VAULT_PROJECTS, шаблоны политик находятся в директории configs/vault-policy-templates. В yaml файле задаются параметры:
-  **gitlab_url**, в него нужно добавить ссылку на группу проекта в GitLab (именно ссылка на группу в которой находится проект, а не на сам проект), далее туда будут добавляться переменные для работы с Vault. При оставление этого поля пустым, проект так же будет создан и переменный role-id и secret-id буду вы выведены в лог пайплайна.
-  **secrets_engine**, тут указывается название движка секретов созданного ранее, который будет использоваться для хранения секретов.
-  **ldap_access_policy**, сюда добавляются имена шаблонов полик из директории configs\vault-policy-templates, к которым будут привязываться пользователи или группы AD для доступа через ldap к Vault через Web UI.
-  **approle_access_policy**, сюда надо добавить имя шаблона полики из директории configs\vault-policy-templates, к которой будет создана и привязана approle. При добавление нескольких политик, в группу проекта будут добавлены переменные (role-id и secret-id) только для первой политики, для остальных они будут выведены в лог пайплайна.
-  **users**, через этот параметр задаются пользователи у которых будут доступы к проему в Vault через Web UI, например test-user2, пользователю по умолчанию будет привязана первая по счету заданная rw_policy, если политик несколько, можно привязать другую указав ее через слеш, например test-user2/test-rw.
-  **groups**, этот параметр работает полностью аналогично предыдущему, так же по умолчанию в группе привязывается первая по списку rw_policy, с возможностью привязки любой другой заданной их списка.
-  **optional_configs**, опциональный параметр для approle, если значения secret_id_num_uses, token_num_uses, token_ttl, token_max_ttl нужны отличающиеся от дефолтных. В нем указывается название политика из ro_policy и задаются переменные, как указанно в примере ниже. Если изменение стандартных параметров не approle не требутся, то параметр optional_configs, можно вообще не добавлять в yaml файл.

_Пример YAML файла, для создания проекта:_
```
####__VAULT__###
#GitLab URL
gitlab_url: http://gitlab.local/testns
#Secrets Engine version
secrets_engine: gitlab-ci-kv1
#Access policies 
ldap_access_policy: 
  - default-rw
  - test-rw
  - default-ro
approle_access_policy: 
  - default-ro
  - test-ro
#Users & Groups
users: 
  - test-user2/test-rw
groups: 
  - test-group1
  - test-group2/test-rw
  - test-group2/default-ro
#Дополнительные конфигурации аппролей создаваемых для approle_access_policy
optional_configs:
  default-ro:
    secret_id_num_uses: "0"
    token_num_uses: "100"
    token_ttl: "120" 
    token_max_ttl: "180"
```